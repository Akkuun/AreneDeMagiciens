[gd_scene load_steps=27 format=3 uid="uid://d0t0fvctdsdhq"]

[ext_resource type="PackedScene" uid="uid://c8l60rnugru40" path="res://addons/godot-xr-tools/objects/pickable.tscn" id="1_3yfio"]
[ext_resource type="PackedScene" uid="uid://c25yxb0vt53vc" path="res://addons/godot-xr-tools/objects/grab_points/grab_point_hand_left.tscn" id="2_73vin"]
[ext_resource type="Script" uid="uid://csdqmanobrcjj" path="res://Scenes/objects/wand/wand.gd" id="2_yq5qq"]
[ext_resource type="PackedScene" uid="uid://bq1kusrecfesx" path="res://assets/meshes/blender/wand.blend" id="3_s8uk8"]
[ext_resource type="Resource" uid="uid://okvpavxxcc41" path="res://resources/hand_poses/wand_holding_left.tres" id="3_yq5qq"]
[ext_resource type="PackedScene" uid="uid://ctw7nbntd5pcj" path="res://addons/godot-xr-tools/objects/grab_points/grab_point_hand_right.tscn" id="4_8hhts"]
[ext_resource type="Resource" uid="uid://bdr8d0jtbncih" path="res://resources/hand_poses/wand_holding_right.tres" id="5_xtfqo"]
[ext_resource type="Script" uid="uid://cchm02t2nltlx" path="res://scripts/patterns/state_manager.gd" id="7_fk80e"]
[ext_resource type="Script" uid="uid://lj50rsn2caqs" path="res://Scenes/objects/wand/vacuum_state.gd" id="9_wc181"]
[ext_resource type="Script" uid="uid://bynyse6gajyha" path="res://Scenes/objects/wand/movements/armed_move_state.gd" id="12_3jn2n"]
[ext_resource type="Script" uid="uid://cr8xly1rucjke" path="res://Scenes/objects/wand/movements/idle_move_state.gd" id="12_h2r10"]
[ext_resource type="Script" uid="uid://chrjy0oxatn52" path="res://Scenes/objects/wand/earth_state.gd" id="13_8wp0l"]
[ext_resource type="Script" uid="uid://dpmxl8bo2cgg" path="res://Scenes/objects/wand/movements/move_recognizer.gd" id="14_8wp0l"]
[ext_resource type="Script" uid="uid://cd2oywdpnsvoe" path="res://Scenes/objects/wand/movements/circle_move_state.gd" id="14_dfwcx"]
[ext_resource type="Script" uid="uid://dxstqnnertx5o" path="res://Scenes/objects/wand/movements/aim_move_state.gd" id="14_xlv2h"]
[ext_resource type="Script" uid="uid://bnukwpbbrirfg" path="res://Scenes/objects/wand/drawing.gd" id="15_xlv2h"]
[ext_resource type="Script" uid="uid://dk3tc2nhfgbbn" path="res://Scenes/objects/wand/movements/fail_state.gd" id="15_yww5m"]
[ext_resource type="Script" uid="uid://dhtmoa2ax2c" path="res://scripts/gestures/gesture_node.gd" id="16_dfwcx"]
[ext_resource type="ArrayMesh" uid="uid://c5kf6djbccoku" path="res://resources/meshes/cloud_1.res" id="19_lvuhq"]

[sub_resource type="CylinderShape3D" id="CylinderShape3D_l64fc"]
height = 0.2
radius = 0.01

[sub_resource type="Curve" id="Curve_yww5m"]
_data = [Vector2(0, 0), 0.0, 0.0, 0, 0, Vector2(1, 1), 0.0, 0.0, 0, 0]
point_count = 2

[sub_resource type="CurveTexture" id="CurveTexture_lvuhq"]
texture_mode = 1
curve = SubResource("Curve_yww5m")

[sub_resource type="ParticleProcessMaterial" id="ParticleProcessMaterial_e6suw"]
particle_flag_rotate_y = true
angle_min = 1.0728835e-05
angle_max = 360.00003
direction = Vector3(0, 1, 0)
gravity = Vector3(0, 0, 0)
scale_min = 0.08
scale_max = 0.08
alpha_curve = SubResource("CurveTexture_lvuhq")
sub_emitter_mode = 4
sub_emitter_amount_at_start = 10

[sub_resource type="ParticleProcessMaterial" id="ParticleProcessMaterial_vuhk8"]
particle_flag_align_y = true
direction = Vector3(0, 1, 0)
spread = 60.0
initial_velocity_max = 1.5
gravity = Vector3(0, -1, 0)
scale_min = 0.099999994
scale_max = 0.39999998

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_lqprr"]
shading_mode = 0
vertex_color_use_as_albedo = true
albedo_color = Color(1, 0.8059726, 0.4822746, 1)

[sub_resource type="SphereMesh" id="SphereMesh_4o2wc"]
material = SubResource("StandardMaterial3D_lqprr")
radius = 0.01
height = 0.2

[node name="Wand" instance=ExtResource("1_3yfio")]
script = ExtResource("2_yq5qq")
sample_rate = 2
sample_count = 60
press_to_hold = false

[node name="CollisionShape3D" parent="." index="0"]
shape = SubResource("CylinderShape3D_l64fc")

[node name="wand" parent="." index="1" instance=ExtResource("3_s8uk8")]
transform = Transform3D(0.1, 0, 0, 0, 0.09999998, 0, 0, 0, 0.09999998, 0, -0.10124746, 0)

[node name="GrabPointHandLeft" parent="." index="2" instance=ExtResource("2_73vin")]
transform = Transform3D(-0.07838624, 0.995616, -0.051033117, 0.54560477, -2.3849136e-08, -0.8380426, -0.8343686, -0.093534924, -0.54321283, 0.028121725, -0.05804334, 0.060428146)
hand_pose = ExtResource("3_yq5qq")

[node name="GrabPointHandRight" parent="." index="3" instance=ExtResource("4_8hhts")]
transform = Transform3D(0.078356035, -0.995616, -0.05107962, -0.5461018, -2.387087e-08, -0.8377186, 0.83404607, 0.093535, -0.5437077, -0.012940228, -0.05799999, 0.06637445)
hand_pose = ExtResource("5_xtfqo")

[node name="Muzzle" type="RayCast3D" parent="." index="4"]
transform = Transform3D(1, 0, 0, 0, 0.99999994, 0, 0, 0, 0.99999994, 0, 0.33566022, 0)
target_position = Vector3(0, 100, 0)

[node name="EffectLocation" type="Marker3D" parent="." index="5"]
transform = Transform3D(1, 0, 0, 0, 0.9999996, 0, 0, 0, 0.9999996, 0, 0.5041536, 0)

[node name="DebugText" type="Label3D" parent="." index="6"]
transform = Transform3D(1, 0, 0, 0, 0.99999994, 0, 0, 0, 0.99999994, 0, 0.33798057, 0)
visible = false
billboard = 2
text = "Current state"
font_size = 24
outline_size = 8

[node name="SpellRecognition" type="Node" parent="." index="7"]
script = ExtResource("7_fk80e")

[node name="IdleMoveState" type="Node" parent="SpellRecognition" index="0" node_paths=PackedStringArray("wand_root", "move_recognizer")]
script = ExtResource("12_h2r10")
wand_root = NodePath("../..")
move_recognizer = NodePath("../../MoveRecognizer")

[node name="Duration" type="Timer" parent="SpellRecognition/IdleMoveState" index="0"]
wait_time = 0.4
one_shot = true

[node name="ArmedMoveState" type="Node" parent="SpellRecognition" index="1" node_paths=PackedStringArray("wand_root", "move_recognizer")]
script = ExtResource("12_3jn2n")
wand_root = NodePath("../..")
move_recognizer = NodePath("../../MoveRecognizer")

[node name="AimMoveState" type="Node" parent="SpellRecognition" index="2" node_paths=PackedStringArray("wand_muzzle", "effect_target")]
script = ExtResource("14_xlv2h")
wand_muzzle = NodePath("../../Muzzle")
effect_target = NodePath("../../EffectLocation")

[node name="CircleMoveState" type="Node" parent="SpellRecognition" index="3" node_paths=PackedStringArray("wand_root", "move_recognizer")]
script = ExtResource("14_dfwcx")
wand_root = NodePath("../..")
move_recognizer = NodePath("../../MoveRecognizer")

[node name="VacuumState" type="Node" parent="SpellRecognition" index="4" node_paths=PackedStringArray("wand_root_node", "wand_muzzle", "move_recognizer")]
script = ExtResource("9_wc181")
wand_root_node = NodePath("../..")
wand_muzzle = NodePath("../../Muzzle")
vacuum_width = 0.5
vacuum_segment_length = 3.0
move_recognizer = NodePath("../../MoveRecognizer")
collision_mask = 22

[node name="EarthState" type="Node" parent="SpellRecognition" index="5" node_paths=PackedStringArray("muzzle")]
script = ExtResource("13_8wp0l")
muzzle = NodePath("../../Muzzle")

[node name="FailState" type="Node" parent="SpellRecognition" index="6" node_paths=PackedStringArray("smoke_effect_node")]
script = ExtResource("15_yww5m")
smoke_effect_node = NodePath("../../FailEffect")

[node name="MoveRecognizer" type="Node" parent="." index="8" node_paths=PackedStringArray("target")]
script = ExtResource("14_8wp0l")
disable = true
target = NodePath("..")
thrust_min_amplitude = 0.3
thrust_y_sensibility = 0.7
circle_radius_tolerance = 6.0
min_circle_radius = 0.1

[node name="Drawing" type="Node" parent="." index="9"]
script = ExtResource("15_xlv2h")

[node name="GestureNode" type="Node2D" parent="Drawing" index="0"]
script = ExtResource("16_dfwcx")

[node name="FailEffect" type="GPUParticles3D" parent="." index="10"]
transform = Transform3D(1, 0, 0, 0, 0.99999994, 0, 0, 0, 0.99999994, 0, 0.5276929, 0)
emitting = false
amount = 3
sub_emitter = NodePath("Smoke")
lifetime = 2.0
one_shot = true
process_material = SubResource("ParticleProcessMaterial_e6suw")
draw_pass_1 = ExtResource("19_lvuhq")

[node name="Smoke" type="GPUParticles3D" parent="FailEffect" index="0"]
emitting = false
amount = 12
one_shot = true
speed_scale = 2.0
process_material = SubResource("ParticleProcessMaterial_vuhk8")
draw_pass_1 = SubResource("SphereMesh_4o2wc")

[connection signal="action_pressed" from="." to="." method="_on_action_pressed"]
[connection signal="action_released" from="." to="." method="_on_action_released"]
[connection signal="grabbed" from="." to="SpellRecognition/IdleMoveState" method="_on_wand_grabbed"]
[connection signal="state_changed" from="SpellRecognition" to="." method="_on_spell_recognition_state_changed"]
[connection signal="timeout" from="SpellRecognition/IdleMoveState/Duration" to="SpellRecognition/IdleMoveState" method="_on_duration_timeout"]
[connection signal="gesture_classified" from="Drawing/GestureNode" to="." method="_on_gesture_node_gesture_classified"]
